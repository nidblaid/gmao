<odoo>
  <data>
    <!-- Tree view for Sales Analytics -->
    <record model="ir.ui.view" id="sales_analytics.list">
      <field name="name">Sales Analytics list</field>
      <field name="model">sales.analytics</field>
      <field name="arch" type="xml">
        <tree editable="top">
            <header>
                <button name="%(sales_analytics.update_results)d" string="Update Results" class="btn-primary" type="action" attrs="{'always_visible': True}"/>
            </header>
          <field name="salesperson"/>
          <field name="data_type"/>
          <field name="worked_days" string="Worked Days"/>
          <field name="leads" string="Active Leads" readonly="1" optional="show" sum="Total"/>
          <field name="dispatched_leads" readonly="1" optional="show" sum="Total"/>
          <field name="processed_leads" readonly="1" optional="show" sum="Total"/>
          <field name="processed_leads_per_day" readonly="1" optional="show" sum="Average"/>          
          <field name="quotations" readonly="1" optional="show" sum="Total"/>
          <field name="salesorders" readonly="1" optional="show" sum="Total"/>
          <field name="confirmation_rate" readonly="1" widget="percentage" optional="show" avg="Average"/>
          <field name="aov" readonly="1" optional="show" avg="Average"/>
          <field name="cr" readonly="1" widget="percentage" optional="show" avg="Average"/>
          <field name="projected_turnover" readonly="1" optional="show" sum="Total"/>
          <field name="delivered" readonly="1" optional="show" sum="Total"/>
          <field name="actual_turnover" readonly="1" optional="show" sum="Total"/>
          <field name="delivery_rate" readonly="1" widget="percentage" optional="show" avg="Average"/>
          <field name="assessment" readonly="1" optional="show"/>
          <field name="score" readonly="1" optional="show" avg="Average"/>
        </tree>
      </field>
    </record>

      <!-- Tree view  for Lead Processing History -->
    <record model="ir.ui.view" id="lead_processing_history">
      <field name="name">Lead Processing History</field>
      <field name="model">lead.processing.history</field>
      <field name="arch" type="xml">
          <tree  create="false" edit="0" >
              <field name="salesperson_id" readonly="1" optional="show" />
              <field name="date_processing" readonly="1" optional="show"/>
              <field name="stage_id" readonly="1" optional="show" />
              <field name="data_status" readonly="1" optional="show" />
              <field name="team_id" readonly="1" optional="show" />  
        </tree>
      </field>
    </record>
    <!-- custom view sale.order -->
    <record id="view_sale_order_custom" model="ir.ui.view">
            <field name="name">sale.order.custom.view</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Ajouter le champ 'deliveries' après le groupe 'customer' -->
                <xpath expr="//group[@name='order_details']" position="after">
                    <group name="deliveries_group" string="Deliveries">
                        <field name="delivery_status"/>
                    </group>
                </xpath>
              <xpath expr="//field[@name='tax_totals_json']" position="after">
                        <field name="total_in_company_currency"/>
                </xpath>
            </field>
        </record>

        <!-- custom view crm.lead -->
    <record id="view_crm_lead_custom" model="ir.ui.view">
            <field name="name">crm.lead.custom.view</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_lead_view_form"/>
            <field name="arch" type="xml">
                <!-- Ajouter le champ 'processing date' après le groupe 'conversion date' -->
                <xpath expr="//field[@name='date_conversion']" position="after">
                        <field name="date_processing"/>
                        <field name="data_status"/>
                  
                </xpath>
            </field>
        </record>
      <!-- Automated action : Update date processing based on Stage or Archive changes 'Al rayyane case'  -->
     <record id="rule_on_update_stage_active" model="base.automation">
      <field name="name">Base Automation: rule on stage or active update</field>
      <field name="model_id" ref="crm.model_crm_lead"/>
      <field name="state">code</field>
      <field name="code">
          <![CDATA[
              for rec in records:
                rec['date_processing'] = datetime.datetime.now() 
          ]]>
      </field>
      <field name="trigger">on_write</field>
      <field name="trigger_field_ids" eval="[(4, ref('crm.field_crm_lead__stage_id')),(4, ref('crm.field_crm_lead__active'))]"/>
      <field name="active" eval="True"/>
      <field name="filter_pre_domain">[["type","=","opportunity"]]</field>
      <field name="filter_domain">["&amp;",["type","=","opportunity"],"|",["stage_id.is_won","=",True],["active","=",False]]</field>
    </record>
    <!-- Automated action : Update date conversion based on salesperson changes 'Al rayyane case'  -->
    <record id="rule_on_update_salesperson" model="base.automation">
      <field name="name">Base Automation: rule on salesperson update</field>
      <field name="model_id" ref="crm.model_crm_lead"/>
      <field name="state">code</field>
      <field name="code">
          <![CDATA[
              for rec in records:
                rec['date_conversion'] = datetime.datetime.now() 
          ]]>
      </field>
      <field name="trigger">on_write</field>
      <field name="trigger_field_ids" eval="[(4, ref('crm.field_crm_lead__user_id'))]"/>
      <field name="active" eval="True"/>
    </record>



      <!-- Custom view res.users -->
    <record id="view_res_users_custom" model="ir.ui.view">
            <field name="name">res.users.custom.view</field>
            <field name="model">res.users</field>
            <field name="inherit_id" ref="base.view_users_form"/>
            <field name="arch" type="xml">
                <!-- Ajouter le champ 'is_salesperson' après le champ 'realted partner' -->
                <xpath expr="//div[@class='oe_title']/group[field[@name='partner_id']]" position="after">
                    <group name="is_salesperson_group">
                      <field name="is_salesperson"/>
                    </group>
                </xpath>
            </field>
        </record>


    <!-- actions opening views on models -->
    <record model="ir.actions.act_window" id="sales_analytics.action_window">
      <field name="name">Sales Analytics</field>
      <field name="res_model">sales.analytics</field>
      <field name="view_mode">tree,dashboard</field>
    </record>

    <record model="ir.actions.act_window" id="lead_processing">
      <field name="name">Lead Processing History</field>
      <field name="res_model">lead.processing.history</field>
      <field name="view_mode">tree</field>
    </record>


    <!-- Top menu item -->
    <menuitem 
      name="Sales Analytics" 
      id="sales_analytics.menu_root"/>
    
    <!-- menu categories -->
    <menuitem 
      name="Sales Analytics" 
      id="sales_analytics.menu_1" 
      parent="sales_analytics.menu_root" 
      action="sales_analytics.action_window"/>
    
    <menuitem name="Lead Processing History" 
      id="lead_processing_history_menu" 
      parent="crm.crm_menu_root" 
      action="lead_processing" 
      sequence="6"/>

  </data>
</odoo>
